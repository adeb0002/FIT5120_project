<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>EcoInsight Melbourne</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts and CSS -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/emission_calculator.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
</head>

<body>
<!-- Header Section with Navigation Bar -->
<div class="header">
    <div class="container">
        <nav class="navbar navbar-inverse" role="navigation">
            <div class="navbar-header">
                <button type="button" id="nav-toggle" class="navbar-toggle" data-toggle="collapse"
                        data-target="#main-nav">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="#" class="navbar-brand scroll-top"><em>Eco</em>Insight</a>
            </div>
            <div id="main-nav" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="index.html" class="scroll-top">Home</a></li>
                    <li><a href="emission_cal_appli.html">Emission Calculator</a></li>
                    <li><a href="#" class="scroll-link" data-id="about">About</a></li>
                    <li><a href="#" class="scroll-link" data-id="contact-us">Contact Us</a></li>
                </ul>
            </div>
        </nav>
    </div>
</div>

<!-- CO2 Emission Calculator Section -->
<div class="parallax-content" id="emission-calculator">
    <div class="container">
        <div class="row">
            <div class="col-md-3 left-section">
                <h2>Carbon Footprint Calculator</h2>
                <div class="line-dec"></div>
                <p>Calculate your carbon footprint by answering a few questions.</p>
            </div>

            <!-- Section 1: Household Size -->
            <div class="col-md-9 right-section">
                <form id="emission-form">
                    <div class="form-group">
                        <label for="household-size">How many people are in your household?</label>
                        <select class="form-control" id="household-size" name="household-size" required>
                            <option value="" disabled selected>Select number of people</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>

                    <!-- Floating Navigation Buttons -->
                    <div class="floating-buttons" id="next-button-section">
                        <a href="index.html" class="scroll-link" id="back-button">
                            <i class="fa fa-arrow-left"></i> Back
                        </a>

                        <a href="#" class="scroll-link" id="next-button">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </div>
                </form>
            </div> <!-- End of right-section -->
        </div> <!-- End of row -->
    </div> <!-- End of container -->
</div> <!-- End of parallax-content -->

<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed');

    var form = document.querySelector('#emission-form');
    if (form) {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('Form submitted');
            await validateAndNavigate();
        });
    } else {
        console.error('Form element not found');
    }

    // Update next button visibility based on the dropdown selection
    document.querySelector('#household-size').addEventListener('change', function() {
        const nextButton = document.querySelector('#next-button');
        nextButton.style.display = this.value ? 'inline' : 'none';
        console.log('Household size changed:', this.value);
    });

    // Initially hide the "Next" button until a valid selection is made
    document.querySelector('#next-button').style.display = 'none';
});

async function validateAndNavigate() {
    if (validateForm()) {
        const data = {
            type: 'personal',
            household_size: Number(document.querySelector('#household-size').value)
        };

        console.log('Original Data:', { household_size: data.household_size });
        console.log('Formatted Data:', data);

        try {
            const lambdaResponse = await sendDataToLambda(data);
            if (lambdaResponse) {
                console.log('Lambda Response:', lambdaResponse);
                // Navigate to the next page after successful Lambda response
                window.location.href = 'emission_cal_solar.html';
            }
        } catch (error) {
            console.error('Error during navigation:', error);
        }
    }
}

function validateForm() {
    let isValid = true;
    const householdSizeSelect = document.querySelector('#household-size');
    const errorElements = document.querySelectorAll('.error');

    console.log('Validating form...');

    // Remove existing error messages
    errorElements.forEach(error => error.remove());

    if (householdSizeSelect.value === "") {
        isValid = false;
        displayError(householdSizeSelect, 'Household size is required.');
        console.log('Validation failed: Household size is required.');
    }

    return isValid;
}

function displayError(element, message) {
    const error = document.createElement('div');
    error.className = 'error';
    error.textContent = message;
    element.parentNode.appendChild(error);
}

async function sendDataToLambda(data) {
    try {
        console.log('Sending data to Lambda:', data);

        const response = await fetch('https://t5tau9uvbf.execute-api.ap-southeast-2.amazonaws.com/Eco/calculator', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        });

        if (!response.ok) {
            const errorDetails = await response.text();
            console.error(`Network response was not ok. Status: ${response.status}. Details: ${errorDetails}`);
            throw new Error(`Network response was not ok. Status: ${response.status}. Details: ${errorDetails}`);
        }

        return response.json();
    } catch (error) {
        console.error('Error sending data:', error);
        alert('There was an error submitting your data. Please try again.');
        return null;
    }
}
</script>
</body>
</html>
