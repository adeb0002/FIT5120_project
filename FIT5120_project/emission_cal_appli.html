<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>EcoInsight Melbourne</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts and CSS -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-calculator.min.css">
    <link rel="stylesheet" href="css/emission_appli.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<!-- Header Section with Navigation Bar -->
<div class="header">
    <div class="container">
        <nav class="navbar navbar-inverse" role="navigation">
            <div class="navbar-header">
                <button type="button" id="nav-toggle" class="navbar-toggle" data-toggle="collapse"
                        data-target="#main-nav">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <img href="index.html" class="navbar-brand scroll-top" src="img/logo.png" alt="EcoInsight Logo"
                     style="height: 80px; margin-right: 10px;">
            </div>
            <div id="main-nav" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="index.html" class="scroll-top">Home</a></li>
                    <li><a href="index.html#contact-us" class="scroll-link" data-id="contact-us">our mission</a></li>
                    <li><a href="index.html#about" class="scroll-link" data-id="about">Services</a></li>
                    <li><a href="emission_cal_personal.html">Emission Calculator</a></li>
                    <li><a href="recommendations.html">Recommendations</a></li>
                </ul>
            </div>
        </nav>
    </div>
</div>

<!-- Loading Animation with Tree GIF -->
<div id="loading-animation" style="display: none;">
    <img src="img/tree.gif" alt="Loading..." style="width: 100px; height: auto;">
    <p>Calculating, please wait...</p>
</div>

<!-- CO2 Emission Calculator Section -->
<div class="parallax-content" id="emission-calculator">
    <div class="container">
        <div class="col-md-3">
            <h2>Carbon Footprint Calculator</h2>
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 80%;" aria-valuemin="0"
                     aria-valuemax="100"></div>
            </div>
        </div>
        <div class="col-md-9">
            <form id="emission-form">
                <!-- Section 1: Appliance Selection -->
                <div class="form-group">
                    <div class="icon-label-container">
                        <div class="appliance-icon-1"></div>
                        <label for="appliance-selection">What appliance(s) do you have in your household?</label>
                    </div>
                    <div id="appliance-selection" class="button-group">
                        <button type="button" class="btn" data-value="television">Television</button>
                        <button type="button" class="btn" data-value="dishwasher">Dishwasher</button>
                        <button type="button" class="btn" data-value="clothes_washer">Clothes Washer</button>
                        <button type="button" class="btn" data-value="clothes_dryer">Clothes Dryer</button>
                        <button type="button" class="btn" data-value="air_conditioner">Air Conditioner</button>
                        <button type="button" class="btn" data-value="refrigerator">Refrigerator</button>
                        <button type="button" class="btn" data-value="none" id="none-checkbox">None of the above
                        </button>
                    </div>

                    <!-- Section 2: Usage Hours (hidden initially) -->
                    <div id="appliance-usage-section" style="display: none;">
                        <div id="usage-questions"></div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Floating Navigation Buttons -->
<div class="floating-buttons">
    <a href="emission_cal_trans.html" class="scroll-link" id="back-button">
        <i class="fa fa-arrow-left"></i> Back</a>

    <a href="#" class="scroll-link" id="next-button">
        Next <i class="fa fa-arrow-right"></i></a>
</div>

<!-- JavaScript -->
<script src="js/vendor/jquery-1.11.1.min.js"></script>
<script src="js/vendor/bootstrap.min.js"></script>
<script src="js/vendor/owl.carousel.min.js"></script>
<script src="js/vendor/lightbox.min.js"></script>
<script src="js/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    // Show the loading animation
    function showLoading() {
        document.getElementById('loading-animation').style.display = 'flex';
    }

    // Hide the loading animation
    function hideLoading() {
        document.getElementById('loading-animation').style.display = 'none';
    }

    // Use sessionStorage to manage the flow properly
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('next-button').style.display = 'none';

    document.getElementById('next-button').addEventListener('click', function(event) {
        event.preventDefault();
        saveDataToLocalStorage();
        validateAndNavigate(); // Validate and navigate to the next page
    });

    document.getElementById('back-button').addEventListener('click', function(event) {
        event.preventDefault();
        if (confirm('Are you sure you want to start over? This will clear all current data.')) {
            clearLocalStorage();
        }
        clearLocalStorage();
        window.history.back();
    });
});

function saveDataToLocalStorage() {
    const selectedAppliances = Array.from(document.querySelectorAll('#appliance-selection .btn.selected-green')).map(button => button.getAttribute('data-value'));

    // Save selected appliances
    localStorage.setItem('applianceData', JSON.stringify(selectedAppliances));

    // Save usage data
    selectedAppliances.forEach(appliance => {
        const usageElement = document.getElementById(`${appliance}-hours`);
        if (usageElement) {
            localStorage.setItem(`${appliance}-hours`, usageElement.value);
        }

        const brandElement = document.getElementById(`${appliance}-brand`);
        if (brandElement) {
            localStorage.setItem(`${appliance}-brand`, brandElement.value);
        }
    });

    console.log('Appliance data and usage data saved to localStorage.');
}


   function clearLocalStorage() {
    localStorage.removeItem('applianceData');

    // Remove each appliance's associated data
    const selectedAppliances = JSON.parse(localStorage.getItem('applianceData')) || [];
    selectedAppliances.forEach(appliance => {
        localStorage.removeItem(`${appliance}-hours`);
        localStorage.removeItem(`${appliance}-brand`);
    });

    console.log('LocalStorage cleared.');
}


    // Clear all selections and ensure local storage management is correct
    function clearAllSelections() {
        document.querySelectorAll('#appliance-selection .appliance-btn').forEach(button => button.classList.remove('selected'));
        document.getElementById('usage-questions').innerHTML = '';
        document.getElementById('appliance-usage-section').style.display = 'none';
        // Optionally clear data specifically related to the selection
        localStorage.removeItem('applianceData');
    }

    // Manage clearing based on page context or user actions
    function handleNavigationClearance() {
        // Check context: only clear if restarting or leaving the entire process
        if (window.location.href.includes('start') || userConfirmedRestart) {
            clearLocalStorage();
        }
    }

    let isRefrigeratorSelected = false;
    let isRefrigeratorBrandSelected = false;

    function selectAppliance() {
    const selectedAppliances = Array.from(document.querySelectorAll('#appliance-selection .btn.selected-green')).map(button => button.getAttribute('data-value'));

    if (selectedAppliances.length === 0) {
        document.getElementById('usage-questions').innerHTML = '';
        document.getElementById('appliance-usage-section').style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
        return;
    }

    // Save selected appliances to localStorage
    localStorage.setItem('applianceData', JSON.stringify(selectedAppliances));
    console.log('Appliance data saved to localStorage:', selectedAppliances);

    updateQuestions(selectedAppliances);
}

function updateQuestions(selectedAppliances) {
    const usageSection = document.getElementById('appliance-usage-section');
    const usageQuestions = document.getElementById('usage-questions');

    const applianceQuestions = {
        'television': 'How many hours do you watch television a week?',
        'dishwasher': 'How many times do you use the dishwasher a week?',
        'clothes_washer': 'How many times do you use the clothes washer a week?',
        'clothes_dryer': 'How many times do you use the clothes dryer a week?',
        'air_conditioner': 'How many hours per day do you use the air conditioner?',
        'refrigerator': 'Select the brand of your refrigerator:'
    };

    usageQuestions.innerHTML = ''; // Clear previous questions

    selectedAppliances.forEach(appliance => {
        const question = applianceQuestions[appliance];
        let questionHTML = '';

        if (appliance === 'refrigerator') {
            loadBrandsFromCSV('new_freezer.csv').then(brands => {
                if (brands.length > 0) {
                    questionHTML = `
                        <div class="form-group">
                            <label for="${appliance}-brand">${question}</label>
                            <select class="form-control" id="${appliance}-brand" name="${appliance}-brand" required style="width: 500px;">
                                <option value="">--Select a Brand--</option>
                                ${brands.map(brand => `<option value="${brand}">${brand}</option>`).join('')}
                            </select>
                        </div>`;
                } else {
                    console.error('No brands loaded for refrigerator.');
                }
                usageQuestions.innerHTML += questionHTML; // Append brand selection dropdown
                updateUsageSectionVisibility();
            });
        } else {
            questionHTML = `
                <div class="form-group">
                    <label for="${appliance}-hours">${question}</label>
                    <input type="number" class="form-control" id="${appliance}-hours" name="${appliance}-hours" min="1" value="1" required>
                </div>`;
            usageQuestions.innerHTML += questionHTML; // Append each question HTML
        }
    });

    updateUsageSectionVisibility();
}

function updateUsageSectionVisibility() {
    const usageSection = document.getElementById('appliance-usage-section');
    const usageQuestions = document.getElementById('usage-questions');

    if (usageQuestions.innerHTML) {
        usageSection.style.display = 'block';
        document.getElementById('next-button').style.display = 'block';
    } else {
        usageSection.style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
    }
}

document.getElementById('appliance-selection').addEventListener('click', function(event) {
    if (event.target.classList.contains('btn')) {
        const noneButton = document.getElementById('none-checkbox');
        const applianceButtons = document.querySelectorAll('#appliance-selection .btn');

        if (event.target.id === 'none-checkbox') {
            noneButton.classList.add('selected-green');
            applianceButtons.forEach(button => {
                if (button.id !== 'none-checkbox') {
                    button.classList.remove('selected-green');
                }
            });
            document.getElementById('usage-questions').innerHTML = '';
            document.getElementById('appliance-usage-section').style.display = 'none';
            document.getElementById('next-button').style.display = 'none';
        } else {
            event.target.classList.toggle('selected-green');
            noneButton.classList.remove('selected-green');
            selectAppliance();
        }
    }
});

    async function loadBrandsFromCSV(url) {
        try {
            const response = await fetch(url);
            const csvText = await response.text();
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const brands = results.data.map(row => row.Brand ? row.Brand.toUpperCase() : '').filter(brand => brand);
                        const uniqueBrands = [...new Set(brands)];
                        uniqueBrands.sort();
                        resolve(uniqueBrands);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        } catch (error) {
            console.error('Error loading CSV:', error);
            return [];
        }
    }

    document.getElementById('show-questions').addEventListener('click', async function() {
        const usageSection = document.getElementById('appliance-usage-section');
        const usageQuestions = document.getElementById('usage-questions');
        const applianceButtons = document.querySelectorAll('#appliance-selection .appliance-btn.selected');

        const applianceQuestions = {
            'television': 'How many hours do you watch television a week?',
            'dishwasher': 'How many times do you use the dishwasher a week?',
            'clothes_washer': 'How many times do you use the clothes washer a week?',
            'clothes_dryer': 'How many times do you use the clothes dryer a week?',
            'air_conditioner': 'How many hours do you use the air conditioner in a week?',
            'refrigerator': 'Select the brand of your refrigerator:',
        };

        usageQuestions.innerHTML = ''; // Clear previous questions

        for (const button of applianceButtons) {
            const appliance = button.getAttribute('data-value');
            const question = applianceQuestions[appliance];
            let questionHTML = '';

            if (appliance === 'refrigerator') {
                const brands = await loadBrandsFromCSV('new_freezer.csv');
                if (brands.length > 0) {
                    questionHTML = `
                        <div class="form-group">
                            <label for="${appliance}-brand">${question}</label>
                            <select class="form-control" id="${appliance}-brand" name="${appliance}-brand" required style="width: 500px;">
                                <option value="">--Select a Brand--</option>
                                ${brands.map(brand => `<option value="${brand}">${brand}</option>`).join('')}
                            </select>
                        </div>`;
                } else {
                    console.error('No brands loaded for refrigerator.');
                }
            } else {
                questionHTML = `
                    <div class="form-group">
                        <label for="${appliance}-hours">${question}</label>
                        <input type="number" class="form-control" id="${appliance}-hours" name="${appliance}-hours" min="1" value="1" required>
                    </div>`;
            }

            usageQuestions.innerHTML += questionHTML; // Append each question HTML
        }

        if (usageQuestions.innerHTML) {
            usageSection.style.display = 'block';
            document.getElementById('next-button').style.display = 'block';
        } else {
            usageSection.style.display = 'none';
            document.getElementById('next-button').style.display = 'none';
        }
    });

        async function sendDataToLambda(data) {
        showLoading();
        try {
            console.log('Original data:', data);

            const applianceData = data.appliances.map(appliance => {
                if (appliance.type === 'refrigerator') {
                    return {
                        type: 'appliance',
                        appliance_type: 'refrigerator',
                        brand: appliance.brand || ''
                    };
                } else {
                    return {
                        type: 'appliance',
                        appliance_type: appliance.type,
                        hours: appliance.hours || 0
                    };
                }
            });

            console.log('Formatted data to send:', applianceData);

            const responses = await Promise.all(applianceData.map(async item => {
                const response = await fetch('https://t5tau9uvbf.execute-api.ap-southeast-2.amazonaws.com/Eco/calculator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item),
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error(`Network response was not ok. Status: ${response.status}. Details: ${errorDetails}`);
                    throw new Error(`Network response was not ok. Status: ${response.status}. Details: ${errorDetails}`);
                }

                return response.json();
            }));

            console.log('Data sent successfully:', responses);
             window.location.href = 'emission_result.html';
            return responses;
        } catch (error) {
            console.error('Error sending data:', error);
            alert('There was an error submitting your data. Please try again.');
        } finally{
            hideLoading();
        }
    }

function validateAndNavigate() {
    const applianceButtons = document.querySelectorAll('#appliance-selection .btn.selected-green');
    const applianceData = [];
    let isValid = true;

    // Check if at least one appliance is selected
    if (applianceButtons.length === 0) {
        alert('Please select at least one appliance.');
        isValid = false;
    } else {
        // Validate input fields for each selected appliance
        applianceButtons.forEach(button => {
        const applianceType = button.getAttribute('data-value');
        if (applianceType === 'refrigerator') {
            // Validate refrigerator brand selection
            const brandSelect = document.getElementById('refrigerator-brand');
            const brand = brandSelect ? brandSelect.value : '';
            if (!brand) {
                alert('Please select a brand for the refrigerator.');
                isValid = false;
                input.style.borderColor = 'red';
            } else {
                applianceData.push({ type: applianceType, brand: brand });
            }
        } else {
            // Validate numeric input for other appliances
            const input = document.querySelector(`#${applianceType}-hours`);
            const value = input ? parseInt(input.value, 10) : 0;
            if (isNaN(value) || value < 1) {
                alert(`Please enter a valid number greater than 0.`);
                isValid = false;
                input.style.borderColor = 'red';
            } else {
                applianceData.push({ type: applianceType, hours: value });
            }
        }
    });
    }

    // Proceed to the next page if all validations pass
    if (isValid) {
        const data = { appliances: applianceData };
        sendDataToLambda(data);
    }
}

</script>
</body>
</html>